import os
import sys
import time
from google import genai
from google.genai import types
from google.genai.errors import APIError

# ==============================================================================
# 1. í™˜ê²½ ì„¤ì • ë° í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
# ==============================================================================

# ì—¬ëŸ¬ ê°€ëŠ¥í•œ í™˜ê²½ ë³€ìˆ˜ ì´ë¦„ì„ í™•ì¸í•˜ê³  ìš°ì„ ìˆœìœ„ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
api_key = os.environ.get("GEMINI_API_KEY") or os.environ.get("GENAI_API_KEY") or os.environ.get("GOOGLE_API_KEY")

# ê°„ë‹¨í•œ ë””ë²„ê·¸ ì¶œë ¥ (ì „ì²´ í‚¤ëŠ” ë…¸ì¶œí•˜ì§€ ì•ŠìŒ)
if api_key:
    print(f"í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ ë°œê²¬: {api_key[:8]}... (ë§ˆìŠ¤í‚¹ëœ ì¶œë ¥)")
else:
    print("í™˜ê²½ë³€ìˆ˜ì— API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. GEMINI_API_KEY / GENAI_API_KEY / GOOGLE_API_KEY ì¤‘ í•˜ë‚˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.")

try:
    # ëª…ì‹œì ìœ¼ë¡œ í‚¤ë¥¼ ì „ë‹¬í•˜ë„ë¡ ë³€ê²½ (ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ api_key ì¸ìë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ ì›ë˜ ë°©ì‹ìœ¼ë¡œ ë³µì›)
    client = genai.Client(api_key=api_key) if api_key else genai.Client()
except Exception as e:
    print("-----------------------------------------------------------------------")
    print("âŒ ì˜¤ë¥˜: Gemini API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    print("í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜, genai.Client(api_key=...)ë¡œ ì§ì ‘ ì „ë‹¬í•˜ì„¸ìš”.")
    print("ì˜ˆ: $env:GEMINI_API_KEY=\"[ë°œê¸‰ë°›ì€ í‚¤]\" (PowerShell) ë˜ëŠ” setx GEMINI_API_KEY \"[ë°œê¸‰ë°›ì€ í‚¤]\"")
    print(f"ìƒì„¸ ì˜¤ë¥˜: {e}")
    sys.exit(1)

MODEL_NAME = "gemini-2.5-flash"
MAX_RETRIES = 3

# ==============================================================================
# 2. í•µì‹¬ í•¨ìˆ˜: API í˜¸ì¶œ (ì§€ìˆ˜ ë°±ì˜¤í”„ í¬í•¨)
# ==============================================================================

def generate_plan_with_retry(payload, system_prompt):
    """
    ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ Gemini APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    """
    for i in range(MAX_RETRIES):
        try:
            print("ğŸš€ AIì—ê²Œ ê³µë¶€ ê³„íš ìƒì„±ì„ ìš”ì²­ ì¤‘...")
            
            # API ìš”ì²­ í˜ì´ë¡œë“œ êµ¬ì„±
            response = client.models.generate_content(
                model=MODEL_NAME,
                contents=payload,
                config=types.GenerateContentConfig(
                    system_instruction=system_prompt,
                )
            )

            if response.text:
                return response.text
            else:
                raise APIError("API ì‘ë‹µì— í…ìŠ¤íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.")

        except APIError as e:
            if i < MAX_RETRIES - 1:
                delay = 2 ** i  # 1ì´ˆ, 2ì´ˆ, 4ì´ˆ ...
                print(f"âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨ (ì¬ì‹œë„ {i+1}/{MAX_RETRIES}). {delay}ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤. (ì˜¤ë¥˜: {e})")
                time.sleep(delay)
            else:
                print(f"âŒ API í˜¸ì¶œ ìµœì¢… ì‹¤íŒ¨. (ì˜¤ë¥˜: {e})")
                raise

# ==============================================================================
# 3. ì‚¬ìš©ì ì…ë ¥ ë° ì¶œë ¥
# ==============================================================================

def main():
    """
    ì‚¬ìš©ì ì…ë ¥ì„ ë°›ê³  ê³µë¶€ ê³„íšì„ ìƒì„±í•˜ì—¬ ì¶œë ¥í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
    """
    print("\n==================================================")
    print("ğŸ“š AI ì‹œí—˜ ëŒ€ë¹„ ê³µë¶€ ê³„íš ìƒì„±ê¸° (Gemini 2.5 Flash)")
    print("==================================================")
    
    try:
        days_remaining = int(input("ğŸ“… ì‹œí—˜ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ (ì •ìˆ˜ë§Œ ì…ë ¥): "))
        
        # ì…ë ¥ ê°€ì´ë“œ
        print("\nğŸ“ ê³¼ëª© ë° ë²”ìœ„ ì…ë ¥ ì˜ˆì‹œ:")
        print("  - [ê³¼ëª©1] ë²”ìœ„: 1ì¥ ~ 4ì¥, ë¹„ì¤‘: ë†’ìŒ")
        print("  - [ê³¼ëª©2] ë²”ìœ„: 5ë‹¨ì› ~ 7ë‹¨ì›, ë¹„ì¤‘: ë³´í†µ")
        subject_scope = input("âœï¸ ê³¼ëª©ë³„ ë²”ìœ„, ë¹„ì¤‘ì„ ìƒì„¸íˆ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì¤„ ë°”ê¿ˆ ê°€ëŠ¥): \n> ")

    except ValueError:
        print("âŒ ì˜¤ë¥˜: ë‚¨ì€ ì¼ìˆ˜ëŠ” ìˆ«ìë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
        return

    # ì‹œìŠ¤í…œ ì§€ì¹¨: ëª¨ë¸ì˜ í˜ë¥´ì†Œë‚˜ì™€ ì¶œë ¥ í˜•ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.
    system_prompt = (
        "ë‹¹ì‹ ì€ ì‹œí—˜ ëŒ€ë¹„ ì „ë¬¸ í•™ìŠµ ì½”ì¹˜ì…ë‹ˆë‹¤. "
        f"ë‚¨ì€ ê¸°ê°„ {days_remaining}ì¼ ë™ì•ˆ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê³¼ëª© ë²”ìœ„ì— ë§ì¶°ì„œ íš¨ìœ¨ì ì¸ í•™ìŠµ ì „ëµì„ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. "
        "ì‘ë‹µì€ ë°˜ë“œì‹œ í•˜ë‚˜ì˜ ë§ˆí¬ë‹¤ìš´(Markdown) í…Œì´ë¸”ê³¼ ìš”ì•½ ì„¤ëª…ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. "
        "ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ìµœì†Œí™”í•˜ê³ , ê³„íšì— ì§‘ì¤‘í•˜ì„¸ìš”."
    )

    # ì‚¬ìš©ì ì¿¼ë¦¬: êµ¬ì²´ì ì¸ ì‘ì—… ìš”ì²­ê³¼ í•„ìˆ˜ ì •ë³´
    user_query = (
        f"ë‚¨ì€ ì¼ìˆ˜: {days_remaining}ì¼. "
        f"ì‹œí—˜ ë²”ìœ„ ë° ì¤‘ìš”ë„ ì •ë³´: \"{subject_scope}\". "
        "ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ì¼ì', 'ê³µë¶€í•  ê³¼ëª©', 'ì£¼ìš” í•™ìŠµ ë‚´ìš©/ëª©í‘œ', 'ê¶Œì¥ ì‹œê°„(ì‹œê°„)'ì„ í¬í•¨í•˜ëŠ” "
        "ì¼ë³„ í•™ìŠµ ê³„íší‘œë¥¼ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. "
        "ì‹œí—˜ ì§ì „ 1ì¼ì€ ë³µìŠµ ë° íœ´ì‹ ì‹œê°„ìœ¼ë¡œ í• ë‹¹í•´ ì£¼ì„¸ìš”. "
    )

    try:
        # API í˜¸ì¶œ ë° ê²°ê³¼ ë°›ê¸°
        study_plan_markdown = generate_plan_with_retry(
            payload=[types.Content(parts=[types.Part.from_text(user_query)])],
            system_prompt=system_prompt
        )

        # ê²°ê³¼ ì¶œë ¥
        print("\n\n" + "="*50)
        print("âœ… AI í•™ìŠµ ê³„íšì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print("="*50)
        print(study_plan_markdown)
        print("="*50 + "\n")

    except APIError:
        print("\nê³„íš ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.")
    except Exception as e:
        print(f"\nì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    main()
